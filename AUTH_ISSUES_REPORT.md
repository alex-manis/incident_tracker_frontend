# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ cookies

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **Race Condition –ø—Ä–∏ Refresh Token** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—É—á–∞—Ç 401 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –≤—Å–µ –æ–Ω–∏ –ø–æ–ø—ã—Ç–∞—é—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —á—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫:
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º –Ω–∞ refresh
- –í–æ–∑–º–æ–∂–Ω—ã–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º —Ç–æ–∫–µ–Ω–æ–≤
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/lib/api.ts:36-58`

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å/–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è refresh –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å cookie –ø—Ä–∏ logout** ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** Backend —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie —Å `path: "/api/auth/refresh"`, –Ω–æ –ø—Ä–∏ logout –æ—á–∏—â–∞–µ—Ç —Å `path: "/"`. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ cookie –ù–ï –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞!

**Backend:**
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞: `path: "/api/auth/refresh"` (config.ts:24)
- –û—á–∏—Å—Ç–∫–∞: `path: "/"` (auth.controller.ts:49)

**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π path –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –æ—á–∏—Å—Ç–∫–µ, –∏–ª–∏ –æ—á–∏—â–∞—Ç—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏

### 3. **–ù–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ logout** ‚ö†Ô∏è –í–ê–ñ–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ logout –æ—á–∏—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ localStorage, –Ω–æ:
- React Query –∫—ç—à –Ω–µ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ú–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- Cookie –º–æ–∂–µ—Ç –Ω–µ –æ—á–∏—Å—Ç–∏—Ç—å—Å—è –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã #2

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/contexts/AuthContext.tsx:49-56`

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ refresh** ‚ö†Ô∏è –í–ê–ñ–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—à–∏–±–∫–µ refresh —Ç–æ–∫–µ–Ω–∞:
- Cookie –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è —è–≤–Ω–æ
- –ú–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω –≤ localStorage
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ refresh token –∏—Å—Ç–µ–∫

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/lib/api.ts:54-58`

### 5. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º React Query** ‚ö†Ô∏è –°–†–ï–î–ù–ï
**–ü—Ä–æ–±–ª–µ–º–∞:** 
- –ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ staleTime –∏ cacheTime
- –ö—ç—à –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ logout –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ú–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/main.tsx:8-15`

### 6. **Race condition –≤ AuthContext** ‚ö†Ô∏è –°–†–ï–î–ù–ï
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `localStorage.getItem('accessToken')` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/contexts/AuthContext.tsx:25, 34, 54, 67`

## üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### Cookie Configuration (Backend)
```typescript
// config.ts
cookieOptions: {
  httpOnly: true,
  secure: isProd,
  sameSite,
  path: "/api/auth/refresh",  // ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π path
  maxAge: 7 * 24 * 60 * 60 * 1000,
}

// auth.controller.ts:49
res.clearCookie(config.cookieName, { path: '/' });  // ‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π path!
```

### Refresh Token Flow
1. –ó–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∞–µ—Ç 401
2. Interceptor –ø—ã—Ç–∞–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
3. –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí –≤—Å–µ –ø—ã—Ç–∞—é—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å
4. –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/–æ—á–µ—Ä–µ–¥–∏

### Logout Flow
1. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `authApi.logout()`
2. Backend –æ—á–∏—â–∞–µ—Ç cookie —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º path
3. Frontend –æ—á–∏—â–∞–µ—Ç localStorage
4. React Query –∫—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `queryClient.clear()`
5. –ù–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å—Å—è

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ):
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –ø—Ä–∏ refresh
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å path cookie –ø—Ä–∏ logout (backend)
3. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ refresh

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ):
4. –£–ª—É—á—à–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ logout
5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å React Query –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
6. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å—Ç–µ—á–µ–Ω–∏—è refresh token

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–£–ª—É—á—à–µ–Ω–∏—è):
7. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ localStorage
8. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
