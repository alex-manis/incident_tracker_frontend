# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ cookies

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **Race Condition –ø—Ä–∏ Refresh Token** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö refresh –∑–∞–ø—Ä–æ—Å–æ–≤

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/lib/api.ts`:**
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `isRefreshing` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö refresh
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å `failedQueue` –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö refresh
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ–ª—É—á–∏–≤—à–∏–µ 401 –≤–æ –≤—Ä–µ–º—è refresh, —Å—Ç–∞–≤—è—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ refresh –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å cookie –ø—Ä–∏ logout** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (Backend)
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Ç–µ –∂–µ –æ–ø—Ü–∏–∏ cookie –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ, —á—Ç–æ –∏ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `incident_tracker_backend/src/controllers/auth.controller.ts`:**
- `clearCookie` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –æ–ø—Ü–∏–∏, —á—Ç–æ –∏ `cookie` –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- –í–∫–ª—é—á–∞—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `path: "/api/auth/refresh"`

### 3. **–ù–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ logout** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–†–µ—à–µ–Ω–∏–µ:** –£–ª—É—á—à–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ logout

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/contexts/AuthContext.tsx`:**
- –î–æ–±–∞–≤–ª–µ–Ω `queryClient.cancelQueries()` –¥–ª—è –æ—Ç–º–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `onError` –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
- –£–ª—É—á—à–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞

### 4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ refresh** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–†–µ—à–µ–Ω–∏–µ:** –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ refresh —Ç–æ–∫–µ–Ω–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/lib/api.ts`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ refresh
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è –Ω–∞ login
- –£–ª—É—á—à–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

### 5. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ React Query** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/main.tsx`:**
- –î–æ–±–∞–≤–ª–µ–Ω `staleTime: 5 –º–∏–Ω—É—Ç` - –¥–∞–Ω–Ω—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Å–≤–µ–∂–∏–º–∏ 5 –º–∏–Ω—É—Ç
- –î–æ–±–∞–≤–ª–µ–Ω `cacheTime: 10 –º–∏–Ω—É—Ç` - –∫—ç—à —Ö—Ä–∞–Ω–∏—Ç—Å—è 10 –º–∏–Ω—É—Ç
- –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ retry - –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ 401/403
- –û—Ç–∫–ª—é—á–µ–Ω retry –¥–ª—è mutations

### 6. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ AuthContext** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
**–†–µ—à–µ–Ω–∏–µ:** –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `src/contexts/AuthContext.tsx`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è auth queries –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –£–ª—É—á—à–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

## üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ú–µ—Ö–∞–Ω–∏–∑–º –æ—á–µ—Ä–µ–¥–∏ refresh —Ç–æ–∫–µ–Ω–æ–≤

```typescript
// –ï—Å–ª–∏ refresh —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
if (isRefreshing) {
  // –ó–∞–ø—Ä–æ—Å —Å—Ç–∞–≤–∏—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
  return new Promise((resolve, reject) => {
    failedQueue.push({ resolve, reject });
  })
    .then((token) => {
      // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ refresh –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
      originalRequest.headers.Authorization = `Bearer ${token}`;
      return api(originalRequest);
    });
}
```

### –û—á–∏—Å—Ç–∫–∞ cookie –ø—Ä–∏ logout

```typescript
// Backend —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –æ–ø—Ü–∏–∏
res.clearCookie(config.cookieName, {
  httpOnly: true,
  secure: config.cookieOptions.secure,
  sameSite: config.cookieOptions.sameSite,
  path: config.cookieOptions.path, // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π path!
});
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ React Query

```typescript
queries: {
  staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
  cacheTime: 10 * 60 * 1000, // 10 –º–∏–Ω—É—Ç
  retry: (failureCount, error) => {
    // –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–∏ 401/403
    const status = (error as any)?.response?.status;
    if (status === 401 || status === 403) return false;
    return failureCount < 1;
  },
}
```

## üîç –ß—Ç–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

1. ‚úÖ Race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
2. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ cookies
3. ‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ logout
4. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ refresh
5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è React Query
6. ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Cookie path:** Backend –∏—Å–ø—Ä–∞–≤–ª–µ–Ω, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å–ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Å—Å–∏–∏
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞
   - Logout —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
   - Refresh –ø—Ä–∏ –∏—Å—Ç–µ–∫—à–µ–º refresh token
   - –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫ refresh
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

**–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!** ‚úÖ
